"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var fs_1 = tslib_1.__importDefault(require("fs"));
var os_1 = tslib_1.__importDefault(require("os"));
var path_1 = tslib_1.__importDefault(require("path"));
var coc_nvim_1 = require("coc.nvim");
var vscode_uri_1 = tslib_1.__importDefault(require("vscode-uri"));
var utils = tslib_1.__importStar(require("./utils"));
var opener_1 = tslib_1.__importDefault(require("./opener"));
var tmpFile;
function init() {
    return tslib_1.__awaiter(this, void 0, void 0, function () {
        var _a, error, tmpDir;
        return tslib_1.__generator(this, function (_b) {
            switch (_b.label) {
                case 0: return [4 /*yield*/, utils.pcb(fs_1.default.mkdtemp)((path_1.default.join(os_1.default.tmpdir(), 'coc-svg')))];
                case 1:
                    _a = _b.sent(), error = _a[0], tmpDir = _a[1];
                    if (!error) {
                        tmpFile = path_1.default.join(tmpDir, 'preview-svg.html');
                    }
                    else {
                        coc_nvim_1.workspace.showMessage("Create temp dir fail: " + error.message);
                    }
                    return [2 /*return*/];
            }
        });
    });
}
function getTextDocument() {
    return tslib_1.__awaiter(this, void 0, void 0, function () {
        var document;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [4 /*yield*/, coc_nvim_1.workspace.getCurrentState()];
                case 1:
                    document = (_a.sent()).document;
                    return [2 /*return*/, document];
            }
        });
    });
}
function isSvgDocument(document) {
    var uri = vscode_uri_1.default.parse(document.uri);
    return uri && (/\.svg$/i.test(uri.path) ||
        document.languageId == 'svg' ||
        document.languageId == 'xml' && /^<svg\b/.test(document.getText({
            start: { line: 0, character: 0 },
            end: { line: 1, character: 0 }
        })));
}
function createHtml(doc) {
    var bg = coc_nvim_1.workspace.getConfiguration('svg.preview').get('background') || 'transparent';
    var bgCustom = coc_nvim_1.workspace.getConfiguration('svg.preview').get('backgroundCustom') || '#eee';
    var svg = doc.getText();
    var html = [];
    html.push('<!DOCTYPE html>\n');
    html.push('<html>');
    html.push('<head></head>');
    html.push("<style type=\"text/css\">\n        .bg-trans {\n            background: url(data:image/gif;base64,R0lGODlhEAAQAIAAAP///8zMzCH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzggNzkuMTU5ODI0LCAyMDE2LzA5LzE0LTAxOjA5OjAxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxNyAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RTI0NUU1RTAzNzdFMTFFNzk2QkFDN0I4QUEyNzlDQkQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RTI0NUU1RTEzNzdFMTFFNzk2QkFDN0I4QUEyNzlDQkQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpFMjQ1RTVERTM3N0UxMUU3OTZCQUM3QjhBQTI3OUNCRCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpFMjQ1RTVERjM3N0UxMUU3OTZCQUM3QjhBQTI3OUNCRCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPS0dDPzs3My8rJyMfGxcTDwsHAv769vLu6ubi3trW0s7KxsK+urayrqqmop6alpKOioaCfnp2cm5qZmJeWlZSTkpGQj46NjIuKiYiHhoWEg4KBgH9+fXx7enl4d3Z1dHNycXBvbm1sa2ppaGdmZWRjYmFgX15dXFtaWVhXVlVUU1JRUE9OTUxLSklIR0ZFRENCQUA/Pj08Ozo5ODc2NTQzMjEwLy4tLCsqKSgnJiUkIyIhIB8eHRwbGhkYFxYVFBMSERAPDg0MCwoJCAcGBQQDAgEAACH5BAAAAAAALAAAAAAQABAAAAIfhG+hq4jM3IFLJhoswNly/XkcBpIiVaInlLJr9FZWAQA7);\n        }\n        .bg-white {\n            background: white;\n        }\n        .bg-black {\n            background: black;\n        }\n        .bg-custom{\n            background: " + bgCustom + ";\n        }\n        body{\n            margin:0;\n            margin-top: 24px;\n            padding:0;\n        }\n        #__toolbar{\n            box-sizing: border-box;\n            position: fixed;\n            left: 0;\n            top:0;\n            height: 24px;\n            width: 100%;\n            z-index: 10000;\n            background: rgba(100,100,100, 0.5);\n        }\n\n        #__toolbar>.btn-group {\n            display:inline-block;\n            margin: 0 4px;\n        }\n        #__toolbar>.btn-group>.btn-bg{\n            margin-top: 3px;\n            width: 17px;\n            height: 17px;\n            border: solid 1px #eee;\n        }\n        #__toolbar>.btn-group>.btn{\n            position:relative;\n            top: -3px;\n            font-size: 10px;\n            height: 17px;\n            border: solid 1px #eee;\n        }\n        #__toolbar>.btn-group>.label{\n            position:relative;\n            padding:0 2px;\n            top: -2px;\n            font-size: 10px;\n            height: 17px;\n            cursor: default;\n        }\n        #__svg{\n            transform-origin:top left;\n            transform:scale(1);\n        }\n        </style>");
    switch (bg) {
        case 'white':
            html.push('<body class="bg-white">');
            break;
        case 'black':
            html.push('<body class="bg-black">');
            break;
        case 'custom':
            html.push('<body class="bg-custom">');
            break;
        default:
            html.push('<body class="bg-trans">');
            break;
    }
    html.push('<div id="__toolbar"></div>');
    html.push('<div id="__svg">');
    html.push(svg);
    html.push('</div>');
    html.push("<script>\n    var toolbar, groupBackground, labelZoom;\n    function createButtonGroup(){\n        var group = document.createElement('div');\n        group.className = 'btn-group';\n        toolbar.appendChild(group);\n        return group;\n    }\n\n    function createButton(parent, content, handler) {\n        var btn = document.createElement('button');\n        btn.type = 'button';\n        parent.appendChild(btn);\n        btn.onclick = handler;\n        if(content) {\n            btn.innerHTML = content;\n        }\n        return btn;\n    }\n\n    var minScale = 0.08;\n    var maxScale = 8;\n    var scale = 1;\n\n    function normalScale() {\n        if(scale < minScale) {\n            scale = minScale\n        }\n        else if(scale > maxScale)\n        {\n            scale = maxScale;\n        }\n        showZoom();\n    }\n\n    function showZoom(){\n        labelZoom.innerText = (scale * 100).toFixed(0) + '%';\n    }\n\n    function init() {\n        toolbar = document.getElementById('__toolbar');\n        groupBackground = createButtonGroup();\n\n        var btnBg = createButton(groupBackground, null, e=>{\n          document.body.className='bg-trans';\n        });\n        btnBg.title = 'Use Transparent Background';\n        btnBg.className = 'btn-bg bg-trans';\n\n        btnBg = createButton(groupBackground, null, e=> {\n          document.body.className='bg-white';\n        });\n        btnBg.title = 'Use White Background';\n        btnBg.className = 'btn-bg bg-white';\n\n        btnBg = createButton(groupBackground, null, e=> {\n          document.body.className='bg-black';\n        });\n        btnBg.title = 'Use Black Background';\n        btnBg.className = 'btn-bg bg-black';\n\n        btnBg = createButton(groupBackground, null, e=> {\n          document.body.className='bg-custom';\n        });\n        btnBg.title = 'Use Custom Background\\nModifty \\'svg.preview.backgroundCustom\\' Setting.';\n        btnBg.className = 'btn-bg bg-custom';\n\n        var groupZoom = createButtonGroup();\n\n        labelZoom = document.createElement('span');\n        labelZoom.style.fontSize = \"10px\";\n        labelZoom.className = 'label';\n\n        showZoom();\n\n        groupZoom.appendChild(labelZoom);\n\n        createButton(groupZoom, 'Original', e=>{\n            scale = 1;\n            showZoom();\n            document.getElementById('__svg').style.transform = 'scale('+scale+')';\n            vscode.postMessage({action: 'scale', scale: scale});\n        }).className = 'btn';\n\n        createButton(groupZoom, 'Zoom In', e=>{\n            scale*=2;\n            normalScale();\n            document.getElementById('__svg').style.transform = 'scale('+scale+')';\n            vscode.postMessage({action: 'scale', scale: scale});\n        }).className = 'btn';\n\n        createButton(groupZoom, 'Zoom Out', e=>{\n            scale/=2;\n            normalScale();\n            document.getElementById('__svg').style.transform = 'scale('+scale+')';\n            vscode.postMessage({action: 'scale', scale: scale});\n        }).className = 'btn';\n    }\n\n    init();\n    </script></body>");
    html.push('</html>');
    return html.join('');
}
function show() {
    return tslib_1.__awaiter(this, void 0, void 0, function () {
        var document, isSvg, html;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [4 /*yield*/, getTextDocument()];
                case 1:
                    document = _a.sent();
                    return [4 /*yield*/, isSvgDocument(document)];
                case 2:
                    isSvg = _a.sent();
                    if (!isSvg) {
                        return [2 /*return*/];
                    }
                    html = createHtml(document);
                    return [4 /*yield*/, utils.pcb(fs_1.default.writeFile)(tmpFile, html, 'utf-8')];
                case 3:
                    _a.sent();
                    opener_1.default(tmpFile);
                    return [2 /*return*/];
            }
        });
    });
}
function svgPreviewer() {
    return tslib_1.__awaiter(this, void 0, void 0, function () {
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    if (!!tmpFile) return [3 /*break*/, 2];
                    return [4 /*yield*/, init()];
                case 1:
                    _a.sent();
                    _a.label = 2;
                case 2:
                    show();
                    return [2 /*return*/];
            }
        });
    });
}
exports.svgPreviewer = svgPreviewer;
//# sourceMappingURL=svgPreviewer.js.map